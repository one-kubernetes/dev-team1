steps:
- bash: |
    cd $(projectName)
    docker build \
        -t $(registryServerName)/$(imageName):$(imageTag) \
        .
  failOnStderr: true
  displayName: 'docker build'
- bash: |
    echo '$(registryPassword)' | docker login \
        $(registryServerName) \
        -u $(registryLogin) \
        --password-stdin
  condition: succeeded()
  displayName: 'docker login'
- bash: |
    docker push $(registryServerName)/$(imageName):$(imageTag)
  failOnStderr: true
  condition: succeeded()
  displayName: 'docker push'
- task: HelmInstaller@1
  displayName: 'install helm'
  inputs:
    helmVersionToInstall: $(helmVersion)
- bash: |
    cd charts/$(projectName)
    sed -i 's/\$\$HELMVERSION\$\$/$(helmChartVersion)/g' Chart.yaml
    sed -i 's/\$\$APPVERSION\$\$/$(imageTag)/g' Chart.yaml
    sed -i 's/\$\$IMAGENAME\$\$/$(registryServerName)\/$(imageName)/g' values.yaml
    helm package \
        --version $(helmChartVersion) \
        --app-version $(imageTag) \
        charts/$(projectName)
  failOnStderr: true
  displayName: 'helm package'
- bash: |
    export HELM_EXPERIMENTAL_OCI=1
    echo $(registryPassword) | helm registry login $(registryName).azurecr.io \
        --username $(registryLogin) \
        --password-stdin
  failOnStderr: true
  name: helmLogin
  condition: succeeded()
  displayName: 'helm registry login'
- bash: |
    curl --data-binary "@$(projectName)-$(helmChartVersion).tgz" http://20.101.8.32:8080/api/charts
  failOnStderr: true
  name: helmPush
  condition: succeeded()
  displayName: 'helm push'
- publish: $(build.artifactStagingDirectory)
  artifact: build-artifact
  # condition: succeeded()
