steps:
- bash: |
    cd $(projectName)
    docker build \
        -t $(registryServerName)/$(imageName):$(imageTag) \
        .
  failOnStderr: true
  displayName: 'docker build'
- bash: |
    echo '$(registryPassword)' | docker login \
        $(registryServerName) \
        -u $(registryLogin) \
        --password-stdin
  condition: succeeded()
  displayName: 'docker login'
- bash: |
    docker push $(registryServerName)/$(imageName):$(imageTag)
  failOnStderr: true
  condition: succeeded()
  displayName: 'docker push'
- task: HelmInstaller@1
  displayName: 'install helm'
  inputs:
    helmVersionToInstall: $(helmVersion)
- bash: |
    cd $(projectName)
    helm package \
        --version $(helmChartVersion) \
        --app-version $(imageTag) \
        charts/$(projectName)
  failOnStderr: true
  displayName: 'helm package'
- bash: |
    cd $(projectName)/charts/parrot
    export HELM_EXPERIMENTAL_OCI=1
    helm chart save . $(projectName):$(helmChartVersion)
    helm chart save . $(registryName).azurecr.io/helm/$(projectName):$(helmChartVersion)
    helm chart list
  failOnStderr: true
  name: helmSave
  condition: succeeded()
  displayName: 'helm chart local save'
- bash: |
    export HELM_EXPERIMENTAL_OCI=1
    echo $(registryPassword) | helm registry login $(registryName).azurecr.io \
        --username $(registryLogin) \
        --password-stdin
  failOnStderr: true
  name: helmLogin
  condition: succeeded()
  displayName: 'helm registry login'
- bash: |
    cd $(projectName)/charts/parrot
    export HELM_EXPERIMENTAL_OCI=1
    helm chart push $(registryName).azurecr.io/helm/$(projectName):$(helmChartVersion)
    echo $(helmChartVersion)
    echo $version
    echo $(jq -n --arg version "$(helmChartVersion)" '{helmChartVersion: $version}') 
    echo $(jq -n --arg version "$(helmChartVersion)" '{helmChartVersion: $version}') > $(build.artifactStagingDirectory)/variables.json
  failOnStderr: true
  name: helmPush
  condition: succeeded()
  displayName: 'helm push'
- publish: $(build.artifactStagingDirectory)
  artifact: build-artifact
  # condition: succeeded()
